name: 'Reusable continuous deployment workflow'

on:
  workflow_call:
    inputs:
      prod-gcp-project-id:
        description: 'GCP project ID for production'
        required: true
        type: string
      create-jira-tickets:
        description: 'Create jira tickets and link items based on commit history'
        default: true
        required: false
        type: boolean
      php-image-name:
        description: 'PHP image name (ex: nginx-fpm-alpine)'
        required: false
        type: string
        default: 'nginx-fpm-alpine'
      composer-self-update:
        description: 'Run composer self-update'
        required: false
        type: boolean
        default: false
      composer-self-update-version:
        description: 'Composer self-update version'
        required: false
        type: string
        default: ''
      composer-no-dev:
        description: 'Run composer install with --no-dev'
        required: false
        type: boolean
        default: false
      slack-channel:
        description: 'Slack channel for error notifications'
        required: true
        type: string
        default: ''
    secrets:
      GH_OAUTH_TOKEN:
        required: true
      QUAY_USER:
        required: true
      QUAY_PASSWORD:
        required: true
      GCR_CREDENTIALS:
        required: true
      JIRA_USER:
        required: true
      JIRA_PASSWORD:
        required: true
      JIRA_URI:
        required: true
      SLACK_WEBHOOK:
        required: true

jobs:
  release:
    name: 'Release new version'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout'
        id: checkout
        uses: actions/checkout@v3.5.2

      - name: 'Create release'
        id: release
        uses: rymndhng/release-on-push-action@v0.28.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          use_github_release_notes: true
          bump_version_scheme: patch
          tag_prefix: v

      - name: 'Login Docker registry (Quay)'
        id: login-quay
        uses: docker/login-action@v2.1.0
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USER }} # Use org secrets for this
          password: ${{ secrets.QUAY_PASSWORD }} # Use org secrets for this

      - name: 'Login backup Docker registry (GCR)'
        id: login-backup-gcr
        uses: docker/login-action@v2.1.0
        with:
          registry: us.gcr.io
          username: _json_key
          password: ${{ secrets.GCR_CREDENTIALS }} # Use org secrets for this

      - name: 'Set PHP image'
        id: set-php-image
        uses: adore-me/gha-image-setup@v1.1.4
        with:
          name: ${{ inputs.php-image-name }}

      - name: 'Load CI config file'
        uses: actions-tools/yaml-outputs@v2
        id: config
        with:
          file-path: ./ci/config.yaml

      - name: 'Check composer'
        uses: adore-me/gha-composer@v3.0.0
        with:
          gh-oauth-token: ${{ secrets.GH_OAUTH_TOKEN }}

      - name: 'Build and push'
        id: docker-build-push
        uses: docker/build-push-action@v5.0.0
        with:
          context: .
          file: ci/Dockerfile
          push: true
          build-args: |
            IMAGE_TAG=${{ steps.set-php-image.outputs.project-image }} 
            SELF_UPDATE=${{ inputs.composer-self-update }}
            NO_DEV=${{ inputs.composer-no-dev }} 
            RUN_LARAVEL_ROUTE_CACHE=${{ steps.config.outputs.run-laravel-route-cache }}
          secrets: |
            COMPOSER_TOKEN=${{ secrets.GH_PRIVATE_ACTIONS_TOKEN_OLD_FORMAT }}
          labels: |
            app.version=${{ steps.release.outputs.tag_name }}
            app.cache.routes=${{ steps.config.outputs.run-laravel-route-cache }}
            git.commit.sha=${{ github.sha }}
            php.image.tag=${{ steps.set-php-image.outputs.project-image-tag }}
            image.type=production
          tags: |
            quay.io/adoreme/${{ github.event.repository.name }}:${{ steps.release.outputs.tag_name }}
            us.gcr.io/${{ inputs.prod-gcp-project-id }}/${{ github.event.repository.name }}:${{ steps.release.outputs.tag_name }}

      - name: Send data to Slack workflow
        uses: act10ns/slack@v2
        with:
          status: ${{ job.status }}
          config: .github/workflows/config/slack.yaml
          channel: ${{ inputs.slack-channel }}
          steps: ${{ toJson(steps) }}
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
    outputs:
      tag: ${{ steps.release.outputs.tag_name }}

  create-jira-ticket:
    name: 'Create JIRA ticket'
    needs: [ release ]
    runs-on: ubuntu-latest
    steps:
      - name: 'Find out if the update is made from a pull request; get the PR number'
        uses: actions/github-script@v6.4.1
        if: inputs.create-jira-tickets
        id: pr-id
        with:
          result-encoding: string
          script: |
            const msg = (context.payload.head_commit.message).match(/#\d+/);
            let pr= Array.isArray(msg) ? parseInt(msg[0].replace('#','')) : 0
            console.log("this is pr number: " + pr)
            return pr

      - name: 'Create jira tickets and link items, send deployment notification'
        uses: adore-me/github-action-deploysbot@v1.0.0
        if: inputs.create-jira-tickets && steps.pr-id.outputs.result > 0
        with:
          JIRA_USER: ${{ secrets.JIRA_USER }}
          JIRA_PASSWORD: ${{ secrets.JIRA_PASSWORD }}
          JIRA_URI: ${{ secrets.JIRA_URI }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_PR_NUMBER: ${{ steps.pr-id.outputs.result }}
          GH_TAG: ${{ needs.release.outputs.tag }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
